<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href="res/icon-web.png" rel="icon">
    <link href="style.css" rel="stylesheet">
    <title>AniYouth | Авторизация</title>
</head>

<body>
    <div class="pc">
        <div class="auth">
            <div class="header-auth">
                <div class="name-icon">AniYouth</div>
                <div style="color: #ccc; transition: .2s;" id="subtitle-auth">Авторизация</div>
            </div>
            
            <div class="ending-auth">
                <div class="form-login" id="login-auth" style="width: 275px;">
                    <form>
                        <div style="padding: 15px, 15px;">
                            <div class="inputico">
                                <input class="input" id="inputNameLogin" type="text" placeholder="Имя">
                                <div class="auth-ico" id="auth-ico-name-one"><i class="fa-solid fa-signature"></i></div>
                            </div>

                            <div class="inputico">
                                <input class="input" id="inputEmailLogin" type="email" placeholder="Почта">
                                <div class="auth-ico" id="auth-ico-email-one"><i class="fa-solid fa-envelope"></i></div>
                            </div>
                            
                            <div class="inputico">
                                <input class="input" id="inputPasswordLogin" type="password" placeholder="Пароль" minlength="8">
                                <div class="auth-ico" id="auth-ico-password-one"><i class="fa-solid fa-key"></i></div>
                            </div>
                        </div>
                    </form>

                    <div class="nextback">
                        <button class="input-btn" id="input-btn-next" type="submit">Далее</button>
                        <button class="input-btn" id="input-btn-back">Назад</button>
                    </div>
                </div>
                

                <div class="active-auth" id="active-auth">
                    <button class="link-button" id="link-google"><svg style="margin-right:12px" width="22" height="22" id="Social_Icons" version="1.1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><g id="_x31__stroke"><g id="Google"><rect fill="none" height="128" width="128"></rect><path d="M27.585,64c0-4.157,0.69-8.143,1.923-11.881L7.938,35.648    C3.734,44.183,1.366,53.801,1.366,64c0,10.191,2.366,19.802,6.563,28.332l21.558-16.503C28.266,72.108,27.585,68.137,27.585,64" fill="#FBBC05"></path><path d="M65.457,26.182c9.031,0,17.188,3.2,23.597,8.436L107.698,16    C96.337,6.109,81.771,0,65.457,0C40.129,0,18.361,14.484,7.938,35.648l21.569,16.471C34.477,37.033,48.644,26.182,65.457,26.182" fill="#EA4335"></path><path d="M65.457,101.818c-16.812,0-30.979-10.851-35.949-25.937    L7.938,92.349C18.361,113.516,40.129,128,65.457,128c15.632,0,30.557-5.551,41.758-15.951L86.741,96.221    C80.964,99.86,73.689,101.818,65.457,101.818" fill="#34A853"></path><path d="M126.634,64c0-3.782-0.583-7.855-1.457-11.636H65.457v24.727    h34.376c-1.719,8.431-6.397,14.912-13.092,19.13l20.474,15.828C118.981,101.129,126.634,84.861,126.634,64" fill="#4285F4"></path></g></g></svg><p>Продолжить с Google</p></button>
                    <button class="link-button" id="link-discord"><svg style="margin-right:12px" width="25" height="25" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M85.22 24.958c-11.459-8.575-22.438-8.334-22.438-8.334l-1.122 1.282c13.623 4.087 19.954 10.097 19.954 10.097-19.491-10.731-44.317-10.654-64.59 0 0 0 6.571-6.331 20.996-10.418l-.801-.962s-10.899-.24-22.438 8.334c0 0-11.54 20.755-11.54 46.319 0 0 6.732 11.54 24.442 12.101 0 0 2.965-3.526 5.369-6.571-10.177-3.045-14.024-9.376-14.024-9.376 6.394 4.001 12.859 6.505 20.916 8.094 13.108 2.698 29.413-.076 41.591-8.094 0 0-4.007 6.491-14.505 9.456a625.034 625.034 0 0 0 5.289 6.411c17.71-.561 24.441-12.101 24.441-12.02-.001-25.564-11.54-46.319-11.54-46.319zM35.055 63.824c-4.488 0-8.174-3.927-8.174-8.815.328-11.707 16.102-11.671 16.348 0 0 4.888-3.607 8.815-8.174 8.815zm29.249 0c-4.488 0-8.174-3.927-8.174-8.815.36-11.684 15.937-11.689 16.348 0 0 4.888-3.606 8.815-8.174 8.815z" id="Layer_2" fill="#ffffff" class="fill-6665d2"></path></svg><p>Войти с Discord</p></button>
                    <button class="link-button" id="link-vk"><svg style="margin-right:13px" width="25" height="25" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13.56C3 8.58197 3 6.09295 4.54648 4.54648C6.09295 3 8.58197 3 13.56 3H14.44C19.418 3 21.907 3 23.4535 4.54648C25 6.09295 25 8.58197 25 13.56V14.44C25 19.418 25 21.907 23.4535 23.4535C21.907 25 19.418 25 14.44 25H13.56C8.58197 25 6.09295 25 4.54648 23.4535C3 21.907 3 19.418 3 14.44V13.56Z" fill="white"></path><path d="M14.7065 18.9C9.68406 18.9 6.81938 15.4466 6.70001 9.70001H9.21581C9.29844 13.9178 11.1531 15.7044 12.6222 16.0728V9.70001H14.9912V13.3376C16.4419 13.1811 17.9659 11.5234 18.4801 9.70001H20.849C20.4542 11.9471 18.8015 13.6047 17.6262 14.2862C18.8015 14.8387 20.6838 16.2846 21.4 18.9H18.7923C18.2322 17.1503 16.8367 15.7965 14.9912 15.6123V18.9H14.7065Z" fill="#0077FF"></path></svg><p>Продолжить с Vk</p></button>
                    <button class="link-button" id="link-github"><i class="fa-brands fa-github" style="font-size: 22px; margin-right: 13px;"></i><p>Войти с GitHub</p></button>
                    <div class="line"></div>
                    <button class="link-button" id="link-email"><i class="fa-solid fa-envelope" style="font-size: 20px; margin-right: 13px;"></i><p>Войти с Email</p></button>
                </div>
            </div>
        </div>
        

        

        <div class="profile">
            
        </div>




    </div>
</body>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyDen-cJJIsnG3H-oQ0hyZwjNd3HaIq_kkw",
        authDomain: "aniyouth-2dcbb.firebaseapp.com",
        databaseURL: "https://aniyouth-2dcbb-default-rtdb.firebaseio.com",
        projectId: "aniyouth-2dcbb",
        storageBucket: "aniyouth-2dcbb.appspot.com",
        messagingSenderId: "761448145133",
        appId: "1:761448145133:web:d2e74bcf71b565e822ece4",
        measurementId: "G-7CNT2E27TL"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);


    var subtitle = document.getElementById("subtitle-auth");
    var iconName1 = document.getElementById("auth-ico-name-one");
    var iconEmail1 = document.getElementById("auth-ico-email-one");
    var iconPassword1 = document.getElementById("auth-ico-password-one");
    var inputNameLogin = document.getElementById("inputNameLogin");
    var inputEmailLogin = document.getElementById("inputEmailLogin");
    var inputPasswordLogin = document.getElementById("inputPasswordLogin");
    var buttonNext = document.getElementById("input-btn-next");
    var buttonBack = document.getElementById("input-btn-back");


    const validateEmail = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;


    function firstHandler() {
        var password = inputPasswordLogin.value.trim();
        var name = inputNameLogin.value.trim();
        const mail = inputEmailLogin.value.trim();
        const email = mail.split("@")[0];

        if (mail !== '') {
            if (validateEmail.test(mail)) {
            // 1. Считываем данные из базы данных по email
            const emailRef = ref(db, 'web/' + email);
            get(emailRef).then((snapshot) => {
                if (snapshot.exists()) {
                // 2. Если данные по email найдены
                    inputPasswordLogin.style.display = "block";
                    iconPassword1.style.display = "block";
                } else {
                // 3. Если данных нет
                    inputEmailLogin.style.display = "none";
                    iconEmail1.style.display = "none";
                    inputNameLogin.style.display = "block";
                    iconName1.style.display = "block";
                    inputPasswordLogin.style.display = "block";
                    iconPassword1.style.display = "block";

                    buttonNext.removeEventListener('click', firstHandler);
                    buttonNext.addEventListener('click', function() {
                        const save_mail = mail;
                        const reload_name = inputNameLogin.value;
                        const reload_password = inputPasswordLogin.value;
                        const reload_password_length = reload_password.length;

                        if (reload_name !== '') {
                            if (reload_password !== '') {
                                if (reload_password_length >= 8) {
                                    set(ref(db, 'web/' + email), {
                                        password: reload_password,
                                        username: reload_name,
                                        caption: "",
                                        avatar: "",
                                        banner: "",
                                        email: mail
                                    }).then(() => {
                                        console.debug("Пользователь успешно добавлен!");
                                        window.location.href = "index.html";
                                    });
                                } else {
                                    window.alert("Пароль должен содержать не менее 8 символов");
                                    inputPasswordLogin.style.border = "2px solid red";
                                    iconPassword1.style.color = "red";
                                }
                            } else {
                                inputPasswordLogin.style.border = "2px solid red";
                                iconPassword1.style.color = "red";
                            }
                        } else {
                            inputNameLogin.style.border = "2px solid red";
                            iconName1.style.color = "red";
                        }

                        buttonNext.removeEventListener('click', secondHandler);
                        buttonNext.addEventListener('click', secondHandler);
                    });
                }
            }).catch((error) => {
                // 4. Обработка ошибок при чтении данных из базы
                console.error("Ошибка при чтении данных:", error);
                alert("Произошла ошибка. Попробуйте снова.");
            });

            } else {
                inputEmailLogin.style.border = "2px solid red";
                iconEmail1.style.color = "red";
            }

        } else {
            inputEmailLogin.style.border = "2px solid red";
            iconEmail1.style.color = "red";
        }

    }


    buttonNext.addEventListener('click', firstHandler);


    buttonBack.addEventListener('click', function() {
        buttonNext.removeEventListener('click', firstHandler);
        buttonNext.addEventListener('click', firstHandler);

        inputNameLogin.style.border = "2px solid #303030";
        inputEmailLogin.style.border = "2px solid #303030";
        inputPasswordLogin.style.border = "2px solid #303030";

        iconName1.style.color = "#303030";
        iconEmail1.style.color = "#303030";
        iconPassword1.style.color = "#303030";

        inputNameLogin.style.display = "none";
        inputNameLogin.value = "";
        iconName1.style.display = "none";
        inputPasswordLogin.style.display = "none";
        inputPasswordLogin.value = "";
        iconPassword1.style.display = "none";
        inputEmailLogin.style.display = "block";
        inputEmailLogin.value = "";
        iconEmail1.style.display = "block";

        activeAuth.style.display = "grid";
        loginAuth.style.display = "none";

        subtitle.innerText = "Авторизация";
    });
    
</script>
<script src="script-auth.js"></script>

</html>